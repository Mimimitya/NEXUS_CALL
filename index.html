<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Nexus Call</title>
</head>
<body>
<h2 id="status">Connecting...</h2>
<audio id="remoteAudio" autoplay></audio>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
const params = new URLSearchParams(location.search);
const roomId = params.get('room');
const userId = params.get('user');
const token = params.get('token');

const socket = io('http://92.113.147.193:2323/', {
    transports: ['websocket']
});

let pc;
let localStream;

async function init() {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });

    pc = new RTCPeerConnection({
        iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    });

    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

    pc.ontrack = e => {
        document.getElementById('remoteAudio').srcObject = e.streams[0];
    };

    pc.onicecandidate = e => {
        if (e.candidate) {
            socket.emit('call_ice', { roomId, candidate: e.candidate });
        }
    };

    socket.emit('call_join', { roomId, userId, token });
}

socket.on('peer_joined', async () => {
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.emit('call_offer', { roomId, offer });
});

socket.on('call_offer', async (offer) => {
    await pc.setRemoteDescription(offer);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    socket.emit('call_answer', { roomId, answer });
});

socket.on('call_answer', async (answer) => {
    await pc.setRemoteDescription(answer);
});

socket.on('call_ice', async (candidate) => {
    await pc.addIceCandidate(candidate);
});

init();
</script>
</body>
</html>
